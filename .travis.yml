env:
    global:
        - REPO_DIR=bezier
        - BUILD_COMMIT=1ae147f81e7a01ba672806a8fd56de25ba2bdcdb
        - BUILD_DEPENDS="numpy"
        - TEST_DEPENDS="--requirement bezier/scripts/requirements.txt"
        - PLAT=x86_64
        - UNICODE_WIDTH=32
        - ENV_VARS_PATH="travis/env_vars.sh"
        - CONFIG_PATH="travis/config.sh"

language: python
python: 2.7
sudo: required
dist: trusty
services: docker

matrix:
  exclude:
    - python: 2.7
  include:
    - os: linux
      env:
        - MB_PYTHON_VERSION=2.7
    - os: linux
      env:
        - MB_PYTHON_VERSION=2.7
        - UNICODE_WIDTH=16
    - os: linux
      env:
        - MB_PYTHON_VERSION=2.7
        - PLAT=i686
    - os: linux
      env:
        - MB_PYTHON_VERSION=2.7
        - PLAT=i686
        - UNICODE_WIDTH=16
    - os: linux
      env:
        - MB_PYTHON_VERSION=3.6
    - os: linux
      env:
        - MB_PYTHON_VERSION=3.6
        - PLAT=i686
    - os: linux
      env:
        - MB_PYTHON_VERSION=3.7
    - os: linux
      env:
        - MB_PYTHON_VERSION=3.7
        - PLAT=i686
    - os: osx
      language: generic
      env:
        - MB_PYTHON_VERSION=2.7
        - MACOSX_DEPLOYMENT_TARGET=10.6
    - os: osx
      language: generic
      env:
        - MB_PYTHON_VERSION=3.6
        - MACOSX_DEPLOYMENT_TARGET=10.6
    - os: osx
      language: generic
      env:
        - MB_PYTHON_VERSION=3.7
        - MACOSX_DEPLOYMENT_TARGET=10.6

before_install:
    - source multibuild/common_utils.sh
    - source multibuild/travis_steps.sh
    - before_install

install:
    - clean_code ${REPO_DIR} ${BUILD_COMMIT}
    - build_wheel ${REPO_DIR} ${PLAT}

script:
    - install_run ${PLAT}

after_success:
    - python -m pip install --upgrade pip virtualenv
    - virtualenv --python=python2.7 gsutil-env
    - gsutil-env/bin/pip install gsutil
    - gsutil-env/bin/python ${TRAVIS_BUILD_DIR}/travis/populate_boto.py
    - export BOTO_CONFIG=${TRAVIS_BUILD_DIR}/.boto
    - openssl aes-256-cbc -K ${encrypted_02a99c88fc32_key} -iv ${encrypted_02a99c88fc32_iv} -in travis/key.json.enc -out key.json -d
    - gsutil-env/bin/gsutil cp ${TRAVIS_BUILD_DIR}/wheelhouse/*.whl gs://${GCS_BUCKET}
